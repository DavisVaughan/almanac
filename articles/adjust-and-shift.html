<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adjusting and Shifting Dates • almanac</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Adjusting and Shifting Dates">
<meta property="og:description" content="almanac">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">almanac</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/almanac.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adjust-and-shift.html">Adjusting and Shifting Dates</a>
    </li>
    <li>
      <a href="../articles/icalendar.html">iCalendar Specification</a>
    </li>
    <li>
      <a href="../articles/quarterly.html">Quarterly Rules</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DavisVaughan/almanac/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Adjusting and Shifting Dates</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DavisVaughan/almanac/blob/master/vignettes/adjust-and-shift.Rmd"><code>vignettes/adjust-and-shift.Rmd</code></a></small>
      <div class="hidden name"><code>adjust-and-shift.Rmd</code></div>

    </div>

    
    
<p>If you have read the introduction vignette, <code><a href="../articles/almanac.html">vignette("almanac")</a></code>, then you’ve seen recurrence rules, rbundles, and the functions <code><a href="../reference/alma_search.html">alma_search()</a></code> and <code><a href="../reference/alma_in.html">alma_in()</a></code>. Additionally included in {almanac} are a set of functions for adjusting and shifting an existing set of dates, <em>relative to an rbundle</em>. They will be the topic of this vignette. The three functions are:</p>
<ul>
<li><p><code>alma_adjust()</code></p></li>
<li><p><code>alma_jump()</code></p></li>
<li><p><code><a href="../reference/alma_step.html">alma_step()</a></code></p></li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">almanac</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>, <span class="kw">warn.conflicts</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<div id="adjusting" class="section level2">
<h2 class="hasAnchor">
<a href="#adjusting" class="anchor"></a>Adjusting</h2>
<p>To talk about either <code>alma_jump()</code> or <code><a href="../reference/alma_step.html">alma_step()</a></code>, we first have to cover <code>alma_adjust()</code>, as it powers both of the others. <code>alma_adjust()</code> will “adjust” an existing set of dates to ensure that no dates currently fall on an “event”, as defined by a provided rbundle or recurrence rule. For example, let’s construct a recurrence rule that includes all weekends in its event set.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">on_weekends</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/rrule.html">weekly</a></span>(<span class="kw">since</span> <span class="kw">=</span> <span class="st">"2000-01-01"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/recur_on_wday.html">recur_on_weekends</a></span>()

<span class="fu"><a href="../reference/alma_search.html">alma_search</a></span>(<span class="st">"2000-01-01"</span>, <span class="st">"2000-01-16"</span>, <span class="no">on_weekends</span>)</pre></body></html></div>
<p>Now, imagine you have an existing set of dates, <code>x</code>. The dates in <code>x</code> might be weekdays or weekends, but you have to ensure that any weekend dates are rolled forward to their next available non-weekend date. To do this, you can use <code>alma_adjust()</code>, which will apply an <code>adjustment</code> repeatedly until your dates are no longer on an event date. The default <code>adjustment</code> is the lubridate function <code><a href="http://lubridate.tidyverse.org/reference/period.html">days(1)</a></code>, to shift forward 1 day.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2000-04-28"</span>) + <span class="fl">0</span>:<span class="fl">8</span>

<span class="co"># Any Saturday / Sunday should be rolled forward to a Monday</span>
<span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x</span>, <span class="fl">TRUE</span>)

<span class="no">x_adjusted</span> <span class="kw">&lt;-</span> <span class="fu">alma_adjust</span>(<span class="no">x</span>, <span class="no">on_weekends</span>)

<span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x_adjusted</span>, <span class="fl">TRUE</span>)</pre></body></html></div>
<p>You could have also rolled the dates backwards to the previous Friday using <code>adjustment = -1</code>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="fu">alma_adjust</span>(<span class="no">x</span>, <span class="no">on_weekends</span>, <span class="kw">adjustment</span> <span class="kw">=</span> -<span class="fl">1</span>), <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="adjustment-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#adjustment-functions" class="anchor"></a>Adjustment Functions</h2>
<p>The <code>adjustment</code> parameter is pretty flexible. It can be a single integer to adjust by a number of days, a lubridate period function like <code><a href="http://lubridate.tidyverse.org/reference/period.html">days()</a></code>, <code><a href="http://lubridate.tidyverse.org/reference/period.html">years()</a></code>, and <code><a href="http://lubridate.tidyverse.org/reference/period.html">weeks()</a></code>, or a function. The function adjustments are particularly useful when your specific adjustment depends on the date in question.</p>
<p>To show this, we’ll pull an example from finance. When traders enter agreements with each other, they often construct a schedule of dates of when one trader should pay the other. There are common conventions that are used to construct these schedules, one of which is to use a <em>modified following</em> rule. This rule states that if a normal payment date is a non-business day (perhaps a weekend or holiday), then it should be adjusted forward to the next available business day <em>unless</em> that date is in the next month, in which case it should instead be adjusted backwards to the next business day.</p>
<p>Take a look at our existing dates, <code>x</code>. The second and third dates are weekends, but they are also right at the end of the month. Adjusting forward would land you in May immediately, so these should be adjusted backwards to <code>2000-04-28</code>. The last date is also a weekend, but the next available business day does not cross into a new month, so the normal adjustment forward should be applied.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">x</span>

<span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>Rather than having to think about how to tackle this, almanac provides a number of <code>adj_*()</code> functions to help out, one of which is <code><a href="../reference/adjustments.html">adj_modified_following()</a></code>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu">alma_adjust</span>(<span class="no">x</span>, <span class="no">on_weekends</span>, <span class="no">adj_modified_following</span>)</pre></body></html></div>
<p><code><a href="../reference/adjustments.html">adj_modified_following()</a></code> is an example of a custom <code>adjustment</code> function, all of which should expect to take the problematic dates as their first argument, and the rbundle as their second argument. The adjustment function is responsible for <em>completely</em> adjusting the dates to the next available business day. It will not be called multiple times.</p>
</div>
<div id="jumping" class="section level2">
<h2 class="hasAnchor">
<a href="#jumping" class="anchor"></a>Jumping</h2>
<p>To build on <code>alma_adjust()</code>, let’s assume that rather than just adjusting existing dates, you actually want to <em>shift</em> the dates first, <em>then</em> perform an adjustment to ensure that you have not landed on an event date. There are two natural ways to perform this shift, captured in <code>alma_jump()</code> and <code><a href="../reference/alma_step.html">alma_step()</a></code>.</p>
<p><code>alma_jump()</code> takes a vector of dates, a rbundle, and a <code>jump</code>, which can be a lubridate Period object, a character string, or an integer number of days to jump. It performs the “jump” all at once, which is essentially equivalent to calling <code>x + days(n)</code>, if you are familiar with lubridate syntax. After the jump has been performed, it calls <code>alma_adjust()</code> on the resulting dates to ensure that the dates that you landed on are non-event dates.</p>
<p>As an example, let’s “jump” forward 1 day with <code>x</code>, providing <code>on_weekends</code> as our rbundle to adjust with. Notice how jumping forward 1 day from Friday lands on Saturday, which is then adjusted to Monday.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">jump</span> <span class="kw">&lt;-</span> <span class="fu">alma_jump</span>(<span class="no">x</span>, <span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">days</a></span>(<span class="fl">1</span>), <span class="no">on_weekends</span>)

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
  <span class="kw">x_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
  <span class="kw">jump</span> <span class="kw">=</span> <span class="no">jump</span>,
  <span class="kw">jump_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">jump</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
)</pre></body></html></div>
<p>Consider what happens when we “jump” forward 2 days.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">jump</span> <span class="kw">&lt;-</span> <span class="fu">alma_jump</span>(<span class="no">x</span>, <span class="fu"><a href="http://lubridate.tidyverse.org/reference/period.html">days</a></span>(<span class="fl">2</span>), <span class="no">on_weekends</span>)

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
  <span class="kw">x_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
  <span class="kw">jump</span> <span class="kw">=</span> <span class="no">jump</span>,
  <span class="kw">jump_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">jump</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
)</pre></body></html></div>
<p>In particular, take a look at what happens with Friday. The jump is applied all at once, landing us on Sunday, and then the adjustment is applied, which moves us to Monday. While this is consistent with what <code>alma_jump()</code> is trying to do, it might not always be what you want. If you want to move forward “2 business days”, for example, then really Friday should be shifted forward to Tuesday, not Monday. To solve this problem, we turn to <code><a href="../reference/alma_step.html">alma_step()</a></code>.</p>
</div>
<div id="stepping" class="section level2">
<h2 class="hasAnchor">
<a href="#stepping" class="anchor"></a>Stepping</h2>
<p><code><a href="../reference/alma_step.html">alma_step()</a></code> is a specialized version of shifting dates that is only applicable when shifting by a set number of days (as opposed to weeks or months). Rather than taking the <code>alma_jump()</code> approach by applying the jump all at once, <code><a href="../reference/alma_step.html">alma_step()</a></code> instead “steps” 1 day at a time, <em>and applies <code>alma_adjust()</code> at every step</em>. This will result in correct “business logic” of stepping forward by “2 business days” that <code>alma_jump()</code> couldn’t provide.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">step</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/alma_step.html">alma_step</a></span>(<span class="no">x</span>, <span class="fl">2</span>, <span class="no">on_weekends</span>)

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
  <span class="kw">x_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">x</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
  <span class="kw">step</span> <span class="kw">=</span> <span class="no">step</span>,
  <span class="kw">step_wday</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/day.html">wday</a></span>(<span class="no">step</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
)</pre></body></html></div>
<p>To break this down, take a look at just that first Friday.</p>
<ul>
<li><p>Start on <code>2000-04-28</code>, a Friday</p></li>
<li><p>Step forward 1 day, to <code>2000-04-29</code>, a Saturday</p></li>
<li><p>Adjust, moving to <code>2000-05-01</code>, a Monday</p></li>
<li><p>Step forward 1 day, to <code>2000-05-02</code>, a Tuesday</p></li>
<li><p>Adjust, but no adjustment is required</p></li>
<li><p>Done, landed on <code>2000-05-02</code></p></li>
</ul>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">friday</span> <span class="kw">&lt;-</span> <span class="no">x</span>[<span class="fl">1</span>]
<span class="no">friday</span>

<span class="fu"><a href="../reference/alma_step.html">alma_step</a></span>(<span class="no">friday</span>, <span class="fl">2</span>, <span class="no">on_weekends</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
